# API

## GET /api/v1/state

возвращает структуру с текущим стейтом по всем каналам. Содержит поля:

* **off_delay** : unsigned int

текущее оставшееся время работы в секундах.

* **mode** : unsigned int (1/0)

текущее состояние канала вкл/выкл

* **count** : unsigned int 

внутренний счетчик переходов через 0. полезной информации не несет. Отлидочный.

Пример: 
```
curl -X GET -H "Content-Type: application/json" http://localhost:8088/api/v1/state

{"result": "success", "command": "sg", "channels": {"A": {"off_delay": "0", "mode": "0", "count": "0"}, "B": {"off_delay": "0", "mode": "0", "count": "0"}}}
```

## POST /api/v1/state

принимает структуру управления текущим стейтом канала. Структура должна содержать поля:

* **channel** : char (A,B,C,D...)

идентификатор канала

* **time** : unsigned int

количество секунд на которые канал должен включиться. 0 -- выключиться.

Пример: 
```
curl -X POST -H "Content-Type: application/json" -d "{\"channel\":\"B\",\"time\":120}" http://localhost:8088/api/v1/state

{"result": "success", "command": "ssB120"}
```

## GET /api/v1/properties

возвращает текущие установки по всем каналам. Содержит поля:

* **guard_time** : unsigned int

время в секундах в течение которого подача входного сигнала считается ошибочной и будет игнорироваться.

* **short_time** : unsigned int

время в секундах в течение которого подача входного сигнала считается "короткой". Выходной сигнал будет включен, но немедленно выключится при пропаже входного. Считается от момента подачи фходного сигнала, а не от конца **guard_time**.

* **off_delay** : unsigned int

время в секундах в течении которого выходной сигнал должен оставаться активным после пропажи входного, если входной сигнал имел длительность больше чем **short_time**. Считается от момента исчезновения входного сигнала.

* **mode** : unsigned int (0/1/2)

режим работы канала

    * 0 -- автоматически
    * 1 -- всегда включен
    * 2 -- всегда выключен

Пример: 
```
curl -X GET -H "Content-Type: application/json" http://localhost:8088/api/v1/properties

{"result": "success", "command": "pg", "channels": {"A": {"guard_time": "2", "short_time": "10", "off_delay": "600", "mode": "2"}, "B": {"guard_time": "2", "short_time": "10", "off_delay": "600", "mode": "0"}}}
```

## POST /api/v1/properties

задает текущие установки по каналам. Может содержать следующие поля: 

* **channel** : char (A,B,C,D…)

идентификатор канала

* **mode** : unsigned int (0/1/2)

режим работы канала

    * 0 -- автоматически
    * 1 -- всегда включен
    * 2 -- всегда выключен

* **short_time** : unsigned int

время в секундах в течение которого подача входного сигнала считается "короткой". Выходной сигнал будет включен, но немедленно выключится при пропаже входного. Считается от момента подачи фходного сигнала, а не от конца **guard_time**.

* **guard_time** : unsigned int

время в секундах в течение которого подача входного сигнала считается ошибочной и будет игнорироваться.

* **delay_time** : unsigned int

время в секундах в течении которого выходной сигнал должен оставаться активным после пропажи входного, если входной сигнал имел длительность больше чем **short_time**. Считается от момента исчезновения входного сигнала.

* **write** : undefined

произвольное значение. Сам факт наличие этого ключа означает, что нужно произвести запись в EEPROM

Все поля кроме "channel" опциональны. Если какое-то из них отсутствует, то соответствующая установка остается прежней.

Общий статус:

* **success**

все установки успешны

* **failed**

ни одна установка не успешна

* **partial**

установки успешны лиш частично

Если статус установок отличен от **success**, команда "write" будет проигнорирована.

Пример: 
```
curl -X POST -H "Content-Type: application/json" -d "{\"channel\":\"B\",\"mode\":\"0\",\"short_time\":"10"}" http://localhost:8088/api/v1/properties

{"channel": "B", "mode": {"result": "success", "command": "psBm0"}, "short_time": {"result": "success", "command": "psBs10"}}
```
